services:
  # ========================================
  # STORAGE NODES (Kubo IPFS only)
  # ========================================
  
  storage-node-1:
    image: ipfs/kubo:latest
    hostname: storage-node-1
    environment:
      IPFS_PROFILE: server
    ports:
      - "5001:5001"  # API
      - "8080:8080"  # Gateway
      - "4001:4001"  # Swarm
    volumes:
      - storage-node-1-data:/data/ipfs
    networks:
      - storage-network

  storage-node-2:
    image: ipfs/kubo:latest
    hostname: storage-node-2
    environment:
      IPFS_PROFILE: server
    ports:
      - "5002:5001"  # API
      - "8081:8080"  # Gateway
      - "4002:4001"  # Swarm
    volumes:
      - storage-node-2-data:/data/ipfs
    networks:
      - storage-network

  storage-node-3:
    image: ipfs/kubo:latest
    hostname: storage-node-3
    environment:
      IPFS_PROFILE: server
    ports:
      - "5003:5001"  # API
      - "8082:8080"  # Gateway
      - "4003:4001"  # Swarm
    volumes:
      - storage-node-3-data:/data/ipfs
    networks:
      - storage-network

  storage-node-4:
    image: ipfs/kubo:latest
    hostname: storage-node-4
    environment:
      IPFS_PROFILE: server
    ports:
      - "5004:5001"  # API
      - "8083:8080"  # Gateway
      - "4004:4001"  # Swarm
    volumes:
      - storage-node-4-data:/data/ipfs
    networks:
      - storage-network

  # ========================================
  # IPFS CLUSTER
  # ========================================
  
  ipfs-cluster-0:
    image: ipfs/ipfs-cluster:latest
    hostname: ipfs-cluster-0
    environment:
      CLUSTER_PEERNAME: cluster-0
      CLUSTER_SECRET: ${CLUSTER_SECRET:-c6d7b8f9e1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8}
      CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /dns4/storage-node-1/tcp/5001
      CLUSTER_CRDT_TRUSTEDPEERS: '*'
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9094
      CLUSTER_MONITORPINGINTERVAL: 2s
      CLUSTER_IPFSCONNECTOR_IPFSNODEPOLICY: ignore-ipfs-api
      # Replication and allocation strategy
      CLUSTER_REPLICATIONFACTORMIN: 2
      CLUSTER_REPLICATIONFACTORMAX: 4
      CLUSTER_ALLOCATION: balanced
    ports:
      - "9094:9094"     # Cluster REST API
      - "9095:9095"     # Cluster RPC API
    volumes:
      - ipfs-cluster-0-data:/data/ipfs-cluster
    depends_on:
      - storage-node-1
    networks:
      - storage-network

  ipfs-cluster-1:
    image: ipfs/ipfs-cluster:latest
    hostname: ipfs-cluster-1
    environment:
      CLUSTER_PEERNAME: cluster-1
      CLUSTER_SECRET: ${CLUSTER_SECRET:-c6d7b8f9e1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8}
      CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /dns4/storage-node-2/tcp/5001
      CLUSTER_CRDT_TRUSTEDPEERS: '*'
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9094
      CLUSTER_MONITORPINGINTERVAL: 2s
      CLUSTER_IPFSCONNECTOR_IPFSNODEPOLICY: ignore-ipfs-api
      # Bootstrap to cluster-0 (will auto-discover)
      CLUSTER_CRDT_BOOTSTRAPPEERS: /dns4/ipfs-cluster-0/tcp/9095
    ports:
      - "9096:9094"     # Cluster REST API
      - "9097:9095"     # Cluster RPC API
    volumes:
      - ipfs-cluster-1-data:/data/ipfs-cluster
    depends_on:
      - storage-node-2
      - ipfs-cluster-0
    networks:
      - storage-network

  ipfs-cluster-2:
    image: ipfs/ipfs-cluster:latest
    hostname: ipfs-cluster-2
    environment:
      CLUSTER_PEERNAME: cluster-2
      CLUSTER_SECRET: ${CLUSTER_SECRET:-c6d7b8f9e1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8}
      CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /dns4/storage-node-3/tcp/5001
      CLUSTER_CRDT_TRUSTEDPEERS: '*'
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9098
      CLUSTER_MONITORPINGINTERVAL: 2s
      CLUSTER_IPFSCONNECTOR_IPFSNODEPOLICY: ignore-ipfs-api
      # Bootstrap to cluster-0 (will auto-discover)
      CLUSTER_CRDT_BOOTSTRAPPEERS: /dns4/ipfs-cluster-0/tcp/9095
    ports:
      - "9098:9098"     # Cluster REST API
      - "9099:9095"     # Cluster RPC API
    volumes:
      - ipfs-cluster-2-data:/data/ipfs-cluster
    depends_on:
      - storage-node-3
      - ipfs-cluster-0
    networks:
      - storage-network

  ipfs-cluster-3:
    image: ipfs/ipfs-cluster:latest
    hostname: ipfs-cluster-3
    environment:
      CLUSTER_PEERNAME: cluster-3
      CLUSTER_SECRET: ${CLUSTER_SECRET:-c6d7b8f9e1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8}
      CLUSTER_IPFSHTTP_NODEMULTIADDRESS: /dns4/storage-node-4/tcp/5001
      CLUSTER_CRDT_TRUSTEDPEERS: '*'
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /ip4/0.0.0.0/tcp/9100
      CLUSTER_MONITORPINGINTERVAL: 2s
      CLUSTER_IPFSCONNECTOR_IPFSNODEPOLICY: ignore-ipfs-api
      # Bootstrap to cluster-0 (will auto-discover)
      CLUSTER_CRDT_BOOTSTRAPPEERS: /dns4/ipfs-cluster-0/tcp/9095
    ports:
      - "9100:9100"     # Cluster REST API  
      - "9101:9095"     # Cluster RPC API
    volumes:
      - ipfs-cluster-3-data:/data/ipfs-cluster
    depends_on:
      - storage-node-4
      - ipfs-cluster-0
    networks:
      - storage-network

  # Cluster management CLI tool
  ipfs-cluster-ctl:
    image: ipfs/ipfs-cluster:latest
    hostname: ipfs-cluster-ctl
    environment:
      CLUSTER_RESTAPI_HTTPLISTENMULTIADDRESS: /dns4/ipfs-cluster-0/tcp/9094
    command: ["tail", "-f", "/dev/null"]  # Keep container running for CLI access
    depends_on:
      - ipfs-cluster-0
    networks:
      - storage-network

volumes:
  storage-node-1-data:
  storage-node-2-data:
  storage-node-3-data:
  storage-node-4-data:
  ipfs-cluster-0-data:
  ipfs-cluster-1-data:
  ipfs-cluster-2-data:
  ipfs-cluster-3-data:

networks:
  storage-network:
    driver: bridge